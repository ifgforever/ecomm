<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inventory Admin</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
            margin: 0;
            background: #0b0f19;
            color: #e5e7eb
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px
        }

        @media (max-width: 768px) {
            .row {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: #111827;
            border: 1px solid rgba(255, 255, 255, .10);
            border-radius: 14px;
            padding: 14px
        }

        input,
        textarea {
            width: 100%;
            background: #0f172a;
            color: #e5e7eb;
            border: 1px solid rgba(255, 255, 255, .10);
            border-radius: 12px;
            padding: 10px 12px;
            box-sizing: border-box
        }

        textarea {
            min-height: 90px;
            resize: vertical
        }

        .btn {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .06);
            color: #e5e7eb;
            text-decoration: none;
            font-weight: 700;
            cursor: pointer
        }

        .btn:hover {
            border-color: rgba(96, 165, 250, .45);
            background: rgba(96, 165, 250, .12)
        }

        .btn.primary {
            background: rgba(34, 197, 94, .2);
            border-color: rgba(34, 197, 94, .4);
        }

        .btn.primary:hover {
            background: rgba(34, 197, 94, .3);
        }

        .btn.small {
            padding: 6px 10px;
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            border-bottom: 1px solid rgba(255, 255, 255, .08);
            padding: 10px;
            text-align: left;
            font-size: 13px
        }

        th {
            color: #9ca3af;
            font-weight: 700
        }

        .muted {
            color: #9ca3af;
            font-size: 13px;
            line-height: 1.4
        }

        .status {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 14px;
            font-size: 13px;
        }

        .status.success {
            background: rgba(34, 197, 94, .15);
            border: 1px solid rgba(34, 197, 94, .3);
            color: #86efac;
        }

        .status.error {
            background: rgba(239, 68, 68, .15);
            border: 1px solid rgba(239, 68, 68, .3);
            color: #fca5a5;
        }

        .status.info {
            background: rgba(59, 130, 246, .15);
            border: 1px solid rgba(59, 130, 246, .3);
            color: #93c5fd;
        }

        .hidden {
            display: none;
        }

        select {
            width: 100%;
            background: #0f172a;
            color: #e5e7eb;
            border: 1px solid rgba(255, 255, 255, .10);
            border-radius: 12px;
            padding: 10px 12px;
        }

        /* Image preview and rotation controls */
        .image-preview-section {
            margin-top: 10px;
            padding: 12px;
            background: #0f172a;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .08);
        }

        .image-preview-container {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .image-preview-wrapper {
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1f2937;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .image-preview-wrapper img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        /* Handle rotated images - when 90/270, we need to fit differently */
        .image-preview-wrapper img.rotated-90,
        .image-preview-wrapper img.rotated-270 {
            max-width: 120px;
            max-height: 120px;
        }

        .rotation-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rotation-buttons {
            display: flex;
            gap: 8px;
        }

        .rotation-info {
            font-size: 12px;
            color: #9ca3af;
        }

        .no-image-preview {
            color: #6b7280;
            font-size: 12px;
            text-align: center;
        }

        /* Table image thumbnails */
        .table-img-wrapper {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1f2937;
            border-radius: 6px;
            overflow: hidden;
        }

        .table-img-wrapper img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .table-rotation-controls {
            display: flex;
            gap: 4px;
            align-items: center;
            margin-top: 4px;
        }

        .btn.rotate-btn {
            padding: 4px 8px;
            font-size: 11px;
            min-width: 28px;
        }

        .rotation-badge {
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(96, 165, 250, .2);
            border-radius: 4px;
            color: #93c5fd;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1 style="margin:0 0 6px;">Inventory Admin</h1>
        <p class="muted">Add/edit products. Changes save to Cloudflare KV automatically.</p>

        <div id="statusMsg" class="status hidden"></div>

        <div class="row">
            <div class="card">
                <h3 style="margin-top:0;">Add / Update product</h3>
                <label class="muted">SKU / ID</label>
                <input id="id" placeholder="SKU-1234" />
                <div style="height:10px"></div>

                <label class="muted">Name</label>
                <input id="name" placeholder="Product name" />
                <div style="height:10px"></div>

                <label class="muted">Price</label>
                <input id="price" type="number" step="0.01" placeholder="19.99" />
                <div style="height:10px"></div>

                <label class="muted">Category</label>
                <input id="category" placeholder="Tools" />
                <div style="height:10px"></div>

                <label class="muted">Quantity</label>
                <input id="quantity" type="number" step="1" placeholder="10" />
                <div style="height:10px"></div>

                <label class="muted">In Stock</label>
                <select id="inStock">
                    <option value="true">Yes - In Stock</option>
                    <option value="false">No - Out of Stock</option>
                </select>
                <div style="height:10px"></div>

                <label class="muted">Image path</label>
                <input id="image" placeholder="images/product.jpg" />

                <!-- Image Preview with Rotation Controls -->
                <div class="image-preview-section" id="imagePreviewSection">
                    <div class="image-preview-container">
                        <div class="image-preview-wrapper" id="imagePreviewWrapper">
                            <div class="no-image-preview" id="noImageText">No image</div>
                            <img id="imagePreview" src="" alt="Preview" style="display: none;" />
                        </div>
                        <div class="rotation-controls" id="rotationControls" style="display: none;">
                            <div class="rotation-buttons">
                                <button type="button" class="btn small" id="rotateLeftBtn" title="Rotate Left 90Â°">â†º Left</button>
                                <button type="button" class="btn small" id="rotateRightBtn" title="Rotate Right 90Â°">â†» Right</button>
                            </div>
                            <div class="rotation-info">
                                Current: <strong id="rotationDegrees">0Â°</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="rotation" value="0" />

                <div style="height:10px"></div>

                <label class="muted">Description</label>
                <textarea id="description" placeholder="Short description"></textarea>

                <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
                    <button class="btn primary" id="save">ðŸ’¾ Save product</button>
                    <button class="btn" id="clear">Clear form</button>
                    <button class="btn" id="download">â¬‡ Download JSON</button>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">Current inventory</h3>
                <div class="muted" id="stats"></div>
                <div style="overflow:auto; margin-top:10px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Cat</th>
                                <th>Qty</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="list"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        let PRODUCTS = [];

        const els = {
            id: document.getElementById("id"),
            name: document.getElementById("name"),
            price: document.getElementById("price"),
            category: document.getElementById("category"),
            quantity: document.getElementById("quantity"),
            inStock: document.getElementById("inStock"),
            image: document.getElementById("image"),
            rotation: document.getElementById("rotation"),
            description: document.getElementById("description"),
            list: document.getElementById("list"),
            stats: document.getElementById("stats"),
            statusMsg: document.getElementById("statusMsg"),
            imagePreview: document.getElementById("imagePreview"),
            imagePreviewWrapper: document.getElementById("imagePreviewWrapper"),
            noImageText: document.getElementById("noImageText"),
            rotationControls: document.getElementById("rotationControls"),
            rotationDegrees: document.getElementById("rotationDegrees"),
            rotateLeftBtn: document.getElementById("rotateLeftBtn"),
            rotateRightBtn: document.getElementById("rotateRightBtn"),
        };

        // Normalize rotation to 0, 90, 180, or 270
        function normalizeRotation(deg) {
            deg = ((deg % 360) + 360) % 360; // Handle negatives
            // Snap to nearest 90
            const snapped = Math.round(deg / 90) * 90;
            return snapped % 360;
        }

        // Get CSS class for rotation
        function getRotationClass(deg) {
            const normalized = normalizeRotation(deg);
            if (normalized === 90) return 'rotated-90';
            if (normalized === 180) return 'rotated-180';
            if (normalized === 270) return 'rotated-270';
            return '';
        }

        // Apply rotation transform to an element
        function applyRotation(imgEl, deg) {
            const normalized = normalizeRotation(deg);
            imgEl.style.transform = `rotate(${normalized}deg)`;
            // Remove old rotation classes
            imgEl.classList.remove('rotated-90', 'rotated-180', 'rotated-270');
            const cls = getRotationClass(normalized);
            if (cls) imgEl.classList.add(cls);
        }

        // Update image preview
        function updateImagePreview() {
            const imagePath = els.image.value.trim();
            const rotation = parseInt(els.rotation.value) || 0;

            if (imagePath) {
                els.imagePreview.src = imagePath;
                els.imagePreview.style.display = 'block';
                els.noImageText.style.display = 'none';
                els.rotationControls.style.display = 'block';
                applyRotation(els.imagePreview, rotation);
                els.rotationDegrees.textContent = normalizeRotation(rotation) + 'Â°';
            } else {
                els.imagePreview.style.display = 'none';
                els.noImageText.style.display = 'block';
                els.rotationControls.style.display = 'none';
            }
        }

        // Rotate handlers for form
        function rotateLeft() {
            const current = parseInt(els.rotation.value) || 0;
            els.rotation.value = normalizeRotation(current - 90);
            updateImagePreview();
        }

        function rotateRight() {
            const current = parseInt(els.rotation.value) || 0;
            els.rotation.value = normalizeRotation(current + 90);
            updateImagePreview();
        }

        els.rotateLeftBtn.addEventListener('click', rotateLeft);
        els.rotateRightBtn.addEventListener('click', rotateRight);
        els.image.addEventListener('input', updateImagePreview);
        els.image.addEventListener('change', updateImagePreview);

        // Handle image load errors
        els.imagePreview.addEventListener('error', () => {
            els.imagePreview.style.display = 'none';
            els.noImageText.textContent = 'Image not found';
            els.noImageText.style.display = 'block';
        });

        els.imagePreview.addEventListener('load', () => {
            els.noImageText.style.display = 'none';
        });

        function showStatus(message, type = "info") {
            els.statusMsg.textContent = message;
            els.statusMsg.className = `status ${type}`;
            setTimeout(() => {
                els.statusMsg.className = "status hidden";
            }, 4000);
        }

        async function load() {
            try {
                // Try API first (Cloudflare KV), fallback to static JSON
                let res;
                try {
                    res = await fetch("/api/products", { cache: "no-store" });
                    if (!res.ok) throw new Error("API not available");
                } catch {
                    res = await fetch("products.json", { cache: "no-store" });
                }
                PRODUCTS = await res.json();
            } catch {
                PRODUCTS = [];
            }
            render();
        }

        async function saveToCloud() {
            try {
                const res = await fetch("/api/products", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(PRODUCTS)
                });

                if (res.ok) {
                    showStatus("âœ“ Saved to cloud!", "success");
                    return true;
                } else {
                    throw new Error("Save failed");
                }
            } catch (error) {
                showStatus("âš  Cloud save failed - download JSON to backup", "error");
                return false;
            }
        }

        function render() {
            els.list.innerHTML = "";
            els.stats.textContent = `${PRODUCTS.length} product(s)`;

            for (const p of PRODUCTS) {
                const rotation = normalizeRotation(p.rotation || 0);
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>
                        <div class="table-img-wrapper">
                            ${p.image 
                                ? `<img src="${esc(p.image)}" alt="${esc(p.name)}" style="transform: rotate(${rotation}deg);" />` 
                                : '<span style="color:#6b7280;font-size:10px;">No img</span>'}
                        </div>
                        ${p.image ? `
                        <div class="table-rotation-controls">
                            <button class="btn rotate-btn" data-rotate-left="${esc(p.id)}" title="Rotate Left">â†º</button>
                            <span class="rotation-badge">${rotation}Â°</span>
                            <button class="btn rotate-btn" data-rotate-right="${esc(p.id)}" title="Rotate Right">â†»</button>
                        </div>
                        ` : ''}
                    </td>
                    <td>${esc(p.id)}</td>
                    <td>${esc(p.name)}</td>
                    <td>$${Number(p.price || 0).toFixed(2)}</td>
                    <td>${esc(p.category || "")}</td>
                    <td>${p.quantity ?? ""}</td>
                    <td style="white-space:nowrap;">
                        <button class="btn small" data-edit="${esc(p.id)}">Edit</button>
                        <button class="btn small" data-del="${esc(p.id)}">Del</button>
                    </td>
                `;
                els.list.appendChild(tr);
            }

            // Attach event listeners
            els.list.querySelectorAll("[data-edit]").forEach(b => b.addEventListener("click", () => edit(b.dataset.edit)));
            els.list.querySelectorAll("[data-del]").forEach(b => b.addEventListener("click", () => del(b.dataset.del)));
            
            // Rotation buttons in table
            els.list.querySelectorAll("[data-rotate-left]").forEach(b => {
                b.addEventListener("click", (e) => {
                    e.stopPropagation();
                    rotateProduct(b.dataset.rotateLeft, -90);
                });
            });
            els.list.querySelectorAll("[data-rotate-right]").forEach(b => {
                b.addEventListener("click", (e) => {
                    e.stopPropagation();
                    rotateProduct(b.dataset.rotateRight, 90);
                });
            });
        }

        // Rotate a product's image directly from the table
        async function rotateProduct(id, delta) {
            const p = PRODUCTS.find(x => x.id === id);
            if (!p) return;
            
            const current = normalizeRotation(p.rotation || 0);
            p.rotation = normalizeRotation(current + delta);
            
            render();
            await saveToCloud();
        }

        function esc(s) {
            return String(s ?? "")
                .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
        }

        function clearForm() {
            els.id.value = "";
            els.name.value = "";
            els.price.value = "";
            els.category.value = "";
            els.quantity.value = "";
            els.inStock.value = "true";
            els.image.value = "";
            els.rotation.value = "0";
            els.description.value = "";
            updateImagePreview();
        }

        function edit(id) {
            const p = PRODUCTS.find(x => x.id === id);
            if (!p) return;
            els.id.value = p.id || "";
            els.name.value = p.name || "";
            els.price.value = p.price ?? "";
            els.category.value = p.category || "";
            els.quantity.value = p.quantity ?? "";
            els.inStock.value = String(!!p.inStock);
            els.image.value = p.image || "";
            els.rotation.value = normalizeRotation(p.rotation || 0);
            els.description.value = p.description || "";
            updateImagePreview();
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        async function del(id) {
            if (!confirm(`Delete product ${id}?`)) return;
            PRODUCTS = PRODUCTS.filter(x => x.id !== id);
            render();
            await saveToCloud();
        }

        async function save() {
            const id = els.id.value.trim();
            if (!id) return alert("SKU/ID is required.");

            const p = {
                id,
                name: els.name.value.trim(),
                price: Number(els.price.value || 0),
                category: els.category.value.trim(),
                quantity: Number(els.quantity.value || 0),
                inStock: els.inStock.value === "true",
                image: els.image.value.trim(),
                rotation: normalizeRotation(parseInt(els.rotation.value) || 0),
                description: els.description.value.trim()
            };

            const idx = PRODUCTS.findIndex(x => x.id === id);
            if (idx >= 0) PRODUCTS[idx] = p;
            else PRODUCTS.unshift(p);

            render();
            clearForm();
            await saveToCloud();
        }

        function download() {
            const blob = new Blob([JSON.stringify(PRODUCTS, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "products.json";
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        document.getElementById("save").addEventListener("click", save);
        document.getElementById("clear").addEventListener("click", clearForm);
        document.getElementById("download").addEventListener("click", download);

        load();
    </script>
</body>

</html>
